<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Painel ‚Ä¢ Proposta de Evento (PDF + WhatsApp)</title>
<!-- INSTRU√á√ïES
1) Troque a LOGO no topo (arquivo ou URL) ‚Äî procure por LOGO_DO_MERCATTO_AQUI (atribua no src dos <img> logoPreview/pdfLogo)
2) Troque o ENDERE√áO no PDF ‚Äî procure por ENDERECO_MERCATTO_AQUI
3) Use "Se√ß√µes personalizadas" para criar blocos (Entradas, Pratos Principais, etc.). Os itens come√ßam EM BRANCO com exemplos no placeholder.
4) Clique em Salvar para guardar localmente e Abrir salvos para reabrir/editar.
-->
<style>
  :root{
    --bg:#0f0f10; --panel:#141414; --line:#2a2a2a; --text:#f4f6fb; --muted:#cfcfcf; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,Helvetica}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  header .brand{display:flex;align-items:center;gap:14px}
  header img{height:56px;width:auto;border-radius:10px;background:#fff;object-fit:contain;border:1px solid var(--line)}
  h1{font-size:1.4rem;margin:0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  label{display:block;font-size:.92rem;margin-bottom:6px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0c0c0c;color:var(--text)}
  textarea{min-height:90px;resize:vertical}
  .row{display:flex;gap:10px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0d1117;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:transparent}
  .btn.ok{background:var(--ok);border-color:transparent}
  .btn.warn{background:var(--warn);border-color:transparent}
  .btn.danger{background:var(--danger);border-color:transparent}
  .btn.ghost{background:#151a22}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .section-title{font-weight:700;margin:8px 0 10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:6px 10px;border:1px solid var(--line);border-radius:40px;background:#0e121a}
  .right{margin-left:auto}
  .muted{color:var(--muted);font-size:.9rem}
  .hr{height:1px;background:var(--line);margin:10px 0}
  /* √Årea do PDF */
  #pdf-area{background:#ffffff;color:#0b0b0e;border:1px solid #e5e7eb;border-radius:12px;padding:24px}
  #pdf-area h2{margin:0 0 6px}
  #pdf-area .muted{color:#4b5563}
  #pdf-area .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin:6px 0}
  #pdf-area .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;font-size:.85rem}
  #pdf-area table{width:100%;border-collapse:collapse;margin-top:6px}
  #pdf-area th,#pdf-area td{border:1px solid #e5e7eb;padding:8px;text-align:left}
  #pdf-area .t-right{text-align:right}
  .notice{padding:8px 12px;border-left:4px solid #3b82f6;background:#eff6ff;color:#1e3a8a;border-radius:8px}
  .section-highlight{background:#f1f5ff;border:1px solid #c7d2fe;color:#1e3a8a;padding:6px 10px;border-radius:10px;font-weight:700}
  .section{border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:10px}
  .section .row{align-items:flex-start}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <!-- LOGO_DO_MERCATTO_AQUI: defina o src abaixo com a URL/arquivo da sua logo -->
      <img id="logoPreview" src="" alt="https://github.com/ClenaStore/contratomercatto/blob/main/paste/Captura%20de%20tela%202025-06-23%20154635.png?raw=true"/>
      <div>
        <h1>Proposta de Evento ‚Ä¢ Mercatto Del√≠cia</h1>
        <div class="muted">Gere um PDF estruturado, salve localmente e envie pelo WhatsApp.</div>
      </div>
    </div>
    <div class="row">
      <!-- Removido: upload de logo -->
      <button class="btn ghost" id="btnExemplo">Preencher com exemplo</button>
    </div>
  </header>

  <div class="card">
    <div class="section-title">Identifica√ß√£o</div>
    <div class="grid g3">
      <div>
        <label>Evento</label>
        <input id="evento" placeholder="Ex.: Lucas"/>
      </div>
      <div style="grid-column:span 2">
        <label>Datas do evento (uma ou mais)</label>
        <div id="datasWrap" style="display:grid;gap:8px"></div>
        <button class="btn" id="btnAddData" type="button">+ Adicionar data</button>
      </div>
    </div>
    <div class="grid g3" style="margin-top:10px">
      <div>
        <label>Hora</label>
        <input id="hora" type="time"/>
      </div>
      <div>
        <label>Sala</label>
        <input id="sala" placeholder="Ex.: Sala VIP 01"/>
      </div>
      <div>
        <label>Pessoas (m√≠nimo)</label>
        <input id="pessoas" type="number" min="1" value="50"/>
      </div>
    </div>
    <div class="grid g3" style="margin-top:10px">
      <div>
        <label>Local de gera√ß√£o (cidade/loja)</label>
        <input id="localGeracao" placeholder="Ex.: Salvador/BA"/>
      </div>
      <div>
        <label>Dura√ß√£o do pacote</label>
        <input id="duracao" placeholder="Ex.: 2h" value="2hrs"/>
      </div>
      <div>
        <label>Incluso</label>
        <input id="incluso" placeholder="Sala exclusiva, gar√ßom, som, TV 86‚Äù, microfone sem fio"/>
      </div>
    </div>
    <div class="hr"></div>
    <div class="grid g3">
      <div>
        <label>Valor por pessoa (R$)</label>
        <input id="valorPessoa" type="number" step="0.01" value="69.90"/>
      </div>
      <div>
        <label>Taxa adicional (%)</label>
        <input id="taxa" type="number" step="0.01" value="10"/>
      </div>
      <div>
        <label>Op√ß√£o alternativa (aluguel espa√ßo) ‚Äì R$</label>
        <input id="aluguel" type="number" step="0.01" value="2500"/>
      </div>
    </div>
  </div>

  <!-- Removido o card de "Entradas (atalhos)" com checkboxes -->

  <div class="card">
    <div class="section-title">Pacotes ‚Äì Caf√© (manh√£/tarde)</div>
    <div class="muted">Monte o buffet, datas e valores destes pacotes opcionais.</div>
    <div class="grid g2" style="margin-top:10px">
      <div>
        <label>Datas sugeridas</label>
        <input id="datasPacotes" placeholder="Ex.: 02-03/10, 27-28/10"/>
      </div>
      <div>
        <label>Dura√ß√£o</label>
        <input id="duracaoCafe" placeholder="1h30" value="1h30"/>
      </div>
    </div>
    <div class="grid g3" style="margin-top:10px">
      <div>
        <label>Valor pacote (ex.: 8 caf√©s / 30 pessoas)</label>
        <input id="valorCafes" type="number" step="0.01" value="21120"/>
      </div>
      <div>
        <label>Fechando 5 datas (valor)</label>
        <input id="valorFechando" type="number" step="0.01" value="22854"/>
      </div>
      <div>
        <label>Incluso (caf√©)</label>
        <input id="inclusoCafe" placeholder="Sala exclusiva, gar√ßom, som, TV 86‚Äù, microfone sem fio"/>
      </div>
    </div>
    <div class="hr"></div>
    <div class="grid g2">
      <div>
        <label>Bebidas</label>
        <textarea id="bebidas" placeholder="Ex.: Caf√©; Leite; Suco de laranja; √Ågua; Refrigerantes (Coca/Guaran√°)"></textarea>
      </div>
      <div>
        <label>Buffet</label>
        <textarea id="buffet" placeholder="Ex.: Farofa de carne de sol; Calabresa acebolada; Ovos mexidos; Frango desfiado; Banana frita; ..."></textarea>
      </div>
    </div>
  </div>

  <!-- Se√ß√µes personalizadas -->
  <div class="card">
    <div class="section-title">Se√ß√µes personalizadas (cabe√ßalhos + itens)</div>
    <div class="muted">Crie blocos como <em>Entradas</em>, <em>Pratos Principais</em>, <em>Bebidas</em>, etc. Os itens iniciam em branco. <br/>Exemplos dentro do campo: <code>Coxinha</code>, <code>Fritas</code>, <code>Pastel</code> (um por linha).</div>
    <div class="row" style="margin-top:8px">
      <input id="secTitulo" placeholder="Ex.: Entradas ou Pratos principais"/>
      <button class="btn" id="btnAddSec">Adicionar se√ß√£o</button>
    </div>
    <div id="secoesWrap"></div>
  </div>

  <div class="card">
    <div class="row">
      <button class="btn" id="btnCalcular">Calcular total</button>
      <button class="btn ghost" id="btnSalvar">Salvar proposta</button>
      <button class="btn ghost" id="btnAbrirSalvos">Abrir salvos</button>
      <div class="chip" id="calcSaida">Total c/ taxa para o m√≠nimo de pessoas: ‚Äî</div>
      <div class="right"></div>
      <button class="btn primary" id="btnGerar">Gerar PDF</button>
      <button class="btn ok" id="btnBaixar" disabled>Baixar PDF</button>
      <button class="btn warn" id="btnWhats" disabled>Enviar pelo WhatsApp</button>
    </div>
    <div class="muted" style="margin-top:8px">O PDF inclui logo, endere√ßo, data/hora e local de gera√ß√£o automaticamente. Os dados podem ser salvos localmente e reabertos depois.</div>
  </div>

  <!-- √Årea oculta para o PDF -->
  <div id="pdf-area" class="card" style="display:none">
    <div style="display:flex;align-items:center;gap:12px">
      <img id="pdfLogo" src="" alt="Logo" style="height:48px;width:auto;border:1px solid #e5e7eb;border-radius:8px;background:#fff"/>
      <div>
        <h2 style="margin:0">Mercatto Del√≠cia ‚Ä¢ Proposta de Evento</h2>
        <div class="muted">ENDERECO_MERCATTO_AQUI <!-- üëâ Substitua este texto pelo endere√ßo do Mercatto Del√≠cia --></div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="tag" id="pdfDataHora">‚Äî</div>
        <div class="muted" id="pdfLocal">Local: ‚Äî</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="kv"><strong>Evento</strong><div id="p_evento">‚Äî</div></div>
    <div class="kv"><strong>Datas</strong><div id="p_datas">‚Äî</div></div>
    <div class="kv"><strong>Hora</strong><div id="p_hora">‚Äî</div></div>
    <div class="kv"><strong>Sala</strong><div id="p_sala">‚Äî</div></div>
    <div class="kv"><strong>Pessoas (m√≠nimo)</strong><div id="p_pessoas">‚Äî</div></div>

    <div class="hr"></div>
    <h3 style="margin:6px 0">Se√ß√µes do Evento</h3>
    <div id="p_secoes"></div>

    <div class="hr"></div>
    <h3 style="margin:6px 0">Valores</h3>
    <table>
      <thead><tr><th>Descri√ß√£o</th><th class="t-right">Valor (R$)</th></tr></thead>
      <tbody>
        <tr><td>Valor por pessoa</td><td class="t-right" id="p_vlrPessoa">‚Äî</td></tr>
        <tr><td>Taxa adicional</td><td class="t-right" id="p_taxa">‚Äî</td></tr>
        <tr><td><strong>Total (m√≠nimo de pessoas)</strong></td><td class="t-right" id="p_totalMin"><strong>‚Äî</strong></td></tr>
        <tr><td>Op√ß√£o alternativa: aluguel do espa√ßo (2h, sem comidas/bebidas)</td><td class="t-right" id="p_aluguel">‚Äî</td></tr>
      </tbody>
    </table>
    <div class="kv"><strong>Datas sugeridas (caf√©)</strong><div id="p_datasPac">‚Äî</div></div>
    <div class="kv"><strong>Dura√ß√£o (caf√©)</strong><div id="p_duracaoCafe">‚Äî</div></div>
    <table>
      <thead><tr><th>Descri√ß√£o</th><th class="t-right">Valor (R$)</th></tr></thead>
      <tbody>
        <tr><td>Pacote (ex.: 8 caf√©s / 30 pessoas)</td><td class="t-right" id="p_valorCafes">‚Äî</td></tr>
        <tr><td>Fechando 5 datas</td><td class="t-right" id="p_valorFechando">‚Äî</td></tr>
      </tbody>
    </table>
    <div class="kv"><strong>Incluso (caf√©)</strong><div id="p_inclusoCafe">‚Äî</div></div>
    <div class="kv"><strong>Bebidas</strong><div id="p_bebidas">‚Äî</div></div>
    <div class="kv"><strong>Buffet</strong><div id="p_buffet">‚Äî</div></div>

    <div class="hr"></div>
    
  </div>

  <div class="muted" style="margin-top:8px">Dica: ap√≥s gerar, voc√™ pode editar os campos e gerar novamente um novo PDF.</div>
</div>

<!-- libs para PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- Modal de salvos -->
<div id="savedModal" style="position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);align-items:center;justify-content:center;z-index:50">
  <div style="background:#11151d;border:1px solid var(--line);border-radius:14px;min-width:70%;max-width:900px;padding:16px">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <h3 style="margin:0">Propostas salvas localmente</h3>
      <div class="right"></div>
      <button class="btn" id="btnFecharModal">Fechar</button>
    </div>
    <div class="muted">Os dados ficam salvos neste navegador (localStorage). Voc√™ pode reabrir para editar/gerar novamente.</div>
    <div id="listaSalvos" style="margin-top:10px;display:grid;gap:8px"></div>
  </div>
</div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const fmtBR = (n)=> (isNaN(n)? '‚Äî' : n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
  const todayBR = ()=>{
    const now = new Date();
    const pad = (x)=> String(x).padStart(2,'0');
    return `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  };
  let lastPdfBlob = null, lastPdfName = null;

  // Preencher com EXEMPLO
  $('#btnExemplo').addEventListener('click', ()=>{
    $('#evento').value = 'Lucas';
    // datas m√∫ltiplas (exemplo)
    $('#datasWrap').innerHTML='';
    addDataRow('2025-09-02');
    addDataRow('2025-10-03');
    $('#hora').value = '19:00';
    $('#sala').value = 'Sala VIP 01';
    $('#pessoas').value = 50;
    $('#valorPessoa').value = 69.90;
    $('#taxa').value = 10;
    $('#duracao').value = '2hrs';
    $('#aluguel').value = 2500;
    $('#incluso').value = 'Sala exclusiva, gar√ßom, som, TV 86‚Äù, microfone sem fio';
    $('#datasPacotes').value = '02-03/10, 27-28/10';
    $('#duracaoCafe').value = '1h30';
    $('#valorCafes').value = 21120;
    $('#valorFechando').value = 22854;
    $('#inclusoCafe').value = 'Sala exclusiva, gar√ßom, som, TV 86‚Äù, microfone sem fio';
    $('#bebidas').value = '';
    $('#buffet').value = '';
    // se√ß√µes exemplo (vazias, com placeholders)
    document.querySelectorAll('#secoesWrap .section').forEach(n=>n.remove());
    addSecao('Entradas');
    addSecao('Pratos Principais');
  });

  // C√°lculo
  function calcularTotal(){
    const pessoas = parseInt($('#pessoas').value||'0',10);
    const vlr = parseFloat($('#valorPessoa').value||'0');
    const taxa = parseFloat($('#taxa').value||'0')/100;
    const total = pessoas * (vlr * (1+taxa));
    $('#calcSaida').textContent = `Total c/ taxa p/ ${pessoas} pessoas: ${fmtBR(total)}`;
    return total;
  }
  $('#btnCalcular').addEventListener('click', calcularTotal);

  // ====== DATAS M√öLTIPLAS ======
  function addDataRow(val=''){
    const row=document.createElement('div');
    row.className='row';
    row.innerHTML=`<input type="date" class="data-item" value="${val}"> <button class="btn warn" type="button">Remover</button>`;
    row.querySelector('button').onclick=()=>row.remove();
    $('#datasWrap').appendChild(row);
  }
  function getDatas(){ return $$('#datasWrap .data-item').map(i=>i.value).filter(Boolean); }
  $('#btnAddData').addEventListener('click', ()=>addDataRow());
  // cria pelo menos uma
  addDataRow();

  // ====== SE√á√ïES PERSONALIZADAS ======
  const secoesWrap = $('#secoesWrap');
  const p_secoes = $('#p_secoes');
  function addSecao(titulo=''){
    const id = 'sec_'+Date.now()+Math.random().toString(36).slice(2,7);
    const el = document.createElement('div');
    el.className = 'section';
    el.dataset.id = id;
    el.innerHTML = `
      <div class="row">
        <div style="flex:1">
          <label>T√≠tulo da se√ß√£o</label>
          <input class="sec-titulo" placeholder="Ex.: Entradas" value="${titulo||''}">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn danger" data-act="rem">Remover</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label>Itens (um por linha)</label>
          <textarea class="sec-itens" placeholder="Ex.:
Coxinha
Fritas
Pastel
..."></textarea>
        </div>
      </div>`;
    el.addEventListener('click', (e)=>{ if(e.target?.dataset?.act==='rem') el.remove(); });
    secoesWrap.appendChild(el);
  }
  $('#btnAddSec').addEventListener('click', ()=>{ const t=$('#secTitulo').value.trim(); addSecao(t); $('#secTitulo').value=''; });
  function collectSecoes(){
    return $$('#secoesWrap .section').map(sec=>({
      id: sec.dataset.id,
      titulo: sec.querySelector('.sec-titulo').value.trim(),
      itens: sec.querySelector('.sec-itens').value.split('
').map(s=>s.trim()).filter(Boolean)
    }));
  }
  function renderSecoesToPDF(){
    if(!p_secoes) return;
    const sections = collectSecoes();
    p_secoes.innerHTML = '';
    sections.forEach(s=>{
      const box = document.createElement('div');
      box.style.margin = '10px 0';
      const h = document.createElement('div');
      h.className = 'section-highlight';
      h.textContent = s.titulo || 'Se√ß√£o';
      box.appendChild(h);
      if(s.itens.length){
        const ul = document.createElement('ul');
        ul.style.margin = '8px 0 0 18px';
        s.itens.forEach(it=>{ const li=document.createElement('li'); li.textContent=it; ul.appendChild(li); });
        box.appendChild(ul);
      }else{
        const p = document.createElement('div');
        p.className = 'muted';
        p.textContent = 'Itens a definir';
        box.appendChild(p);
      }
      p_secoes.appendChild(box);
    });
  }

  // Fun√ß√£o para LIMPAR todo o formul√°rio ap√≥s gerar o PDF
  function clearForm(){
    // campos b√°sicos
    ['evento','hora','sala','pessoas','localGeracao','valorPessoa','taxa','duracao','aluguel','incluso','datasPacotes','duracaoCafe','valorCafes','valorFechando','inclusoCafe','bebidas','buffet'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.value='';
    });
    // datas m√∫ltiplas
    const wrap=document.getElementById('datasWrap'); if(wrap){ wrap.innerHTML=''; }
    if(typeof addDataRow==='function') addDataRow();
    // se√ß√µes personalizadas
    const secoesWrap=document.getElementById('secoesWrap'); if(secoesWrap){ secoesWrap.innerHTML=''; }
    // feedback/calculo
    const chip=document.getElementById('calcSaida'); if(chip){ chip.textContent='Total c/ taxa para o m√≠nimo de pessoas: ‚Äî'; }
    // desabilitar bot√µes de baixar/whats at√© nova gera√ß√£o
    const b1=document.getElementById('btnBaixar'); const b2=document.getElementById('btnWhats');
    if(b1) b1.disabled=true; if(b2) b2.disabled=true;
    // resetar √∫ltimo PDF
    if(typeof lastPdfBlob!=='undefined'){ lastPdfBlob=null; lastPdfName=null; }
  }

  // Montagem do PDF
  function montarPDFView(){
    $('#pdfDataHora').textContent = 'Gerado em ' + todayBR();
    $('#pdfLocal').textContent = 'Local: ' + ($('#localGeracao').value||'‚Äî');

    $('#p_evento').textContent = $('#evento').value || '‚Äî';
    const datas = getDatas();
    const datasFmt = datas.map(d=>{ try{ return new Date(d+'T00:00:00').toLocaleDateString('pt-BR'); }catch(e){ return d; } });
    $('#p_datas').textContent = datasFmt.length? datasFmt.join(', ') : '‚Äî';
    $('#p_hora').textContent = $('#hora').value || '‚Äî';
    $('#p_sala').textContent = $('#sala').value || '‚Äî';
    $('#p_pessoas').textContent = $('#pessoas').value || '‚Äî';

    const vlr = parseFloat($('#valorPessoa').value||'0');
    const taxa = parseFloat($('#taxa').value||'0');
    const totalMin = calcularTotal();
    $('#p_vlrPessoa').textContent = fmtBR(vlr);
    $('#p_taxa').textContent = `${isNaN(taxa)?'0':taxa.toLocaleString('pt-BR')}%`;
    $('#p_totalMin').textContent = fmtBR(totalMin);
    $('#p_aluguel').textContent = fmtBR(parseFloat($('#aluguel').value||'0'));
    $('#p_inclusoCafe').textContent = $('#inclusoCafe').value || '‚Äî';
    $('#p_datasPac').textContent = $('#datasPacotes').value || '‚Äî';
    $('#p_duracaoCafe').textContent = $('#duracaoCafe').value || '‚Äî';
    $('#p_valorCafes').textContent = fmtBR(parseFloat($('#valorCafes').value||'0'));
    $('#p_valorFechando').textContent = fmtBR(parseFloat($('#valorFechando').value||'0'));
    $('#p_bebidas').textContent = $('#bebidas').value || '‚Äî';
    $('#p_buffet').textContent = $('#buffet').value || '‚Äî';

    // logo do PDF usa o mesmo src do preview (defina no HTML)
    document.getElementById('pdfLogo').src = document.getElementById('logoPreview').src || '';

    renderSecoesToPDF();
  }

  async function gerarPDF(){
    montarPDFView();
    const area = document.getElementById('pdf-area');
    area.style.display = '';
    const canvas = await html2canvas(area, {scale:2, background:'#ffffff'});
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:'pt', format:'a4', compress:true});
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 24;
    const imgWidth = pageWidth - margin*2;
    const imgHeight = canvas.height * (imgWidth / canvas.width);
    pdf.addImage(img, 'PNG', margin, margin, imgWidth, imgHeight, '', 'FAST');
    const nome = `Proposta_Mercatto_${($('#evento').value||'Evento')}_${new Date().toISOString().slice(0,10)}.pdf`;
    lastPdfBlob = pdf.output('blob');
    lastPdfName = nome;
    document.getElementById('btnBaixar').disabled = false;
    document.getElementById('btnWhats').disabled = false;
    area.style.display = 'none';
    return {pdf, nome};
  }

  // ====== PERSIST√äNCIA LOCAL ======
  const STORE_KEY = 'mercatto_evento_propostas_v1';
  function loadAll(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }catch(e){ return []; } }
  function saveAll(list){ localStorage.setItem(STORE_KEY, JSON.stringify(list)); }
  function makeRecord(){
    return {
      id: Date.now().toString(36)+Math.random().toString(36).slice(2),
      createdAt: new Date().toISOString(),
      nome: ($('#evento').value||'Proposta')+ ' - ' + (new Date().toLocaleDateString('pt-BR')),
      logo: (document.getElementById('logoPreview').src||''),
      data: {
        evento: $('#evento').value, datas: getDatas(), hora: $('#hora').value, sala: $('#sala').value,
        pessoas: $('#pessoas').value, local: $('#localGeracao').value,
        valorPessoa: $('#valorPessoa').value, taxa: $('#taxa').value, duracao: $('#duracao').value,
        aluguel: $('#aluguel').value, incluso: $('#incluso').value,
        datasPacotes: $('#datasPacotes').value, duracaoCafe: $('#duracaoCafe').value,
        valorCafes: $('#valorCafes').value, valorFechando: $('#valorFechando').value,
        inclusoCafe: $('#inclusoCafe').value, bebidas: $('#bebidas').value, buffet: $('#buffet').value,
        secoes: collectSecoes()
      }
    };
  }
  function applyRecord(rec){
    const d = rec.data||{};
    $('#evento').value = d.evento||''; $('#hora').value=d.hora||''; $('#sala').value=d.sala||'';
    $('#pessoas').value=d.pessoas||''; $('#localGeracao').value=d.local||'';
    $('#valorPessoa').value=d.valorPessoa||''; $('#taxa').value=d.taxa||''; $('#duracao').value=d.duracao||'';
    $('#aluguel').value=d.aluguel||''; $('#incluso').value=d.incluso||'';
    $('#datasPacotes').value=d.datasPacotes||''; $('#duracaoCafe').value=d.duracaoCafe||'';
    $('#valorCafes').value=d.valorCafes||''; $('#valorFechando').value=d.valorFechando||'';
    $('#inclusoCafe').value=d.inclusoCafe||''; $('#bebidas').value=d.bebidas||''; $('#buffet').value=d.buffet||'';
    // datas m√∫ltiplas (suporta legado 'data')
    $('#datasWrap').innerHTML='';
    const datas = Array.isArray(d.datas)? d.datas : (d.data? [d.data] : []);
    if(!datas.length) addDataRow(); else datas.forEach(addDataRow);
    // se√ß√µes
    document.querySelectorAll('#secoesWrap .section').forEach(n=>n.remove());
    (d.secoes||[]).forEach(s=>{ addSecao(s.titulo); const last=secoesWrap.lastElementChild; last.querySelector('.sec-itens').value=(s.itens||[]).join('
'); });
    if(rec.logo){ document.getElementById('logoPreview').src = rec.logo; document.getElementById('pdfLogo').src = rec.logo; }
  }
  function salvar(){ const list=loadAll(); const rec=makeRecord(); list.unshift(rec); saveAll(list); return rec; }

  // UI salvar/abrir
  document.getElementById('btnSalvar').addEventListener('click', ()=>{ const rec=salvar(); alert('Proposta salva localmente: '+rec.nome); });
  const modal = document.getElementById('savedModal');
  const listaSalvos = document.getElementById('listaSalvos');
  function openModal(){
    listaSalvos.innerHTML = '';
    const list = loadAll();
    if(!list.length){ listaSalvos.innerHTML = '<div class="muted">Nenhum item salvo ainda.</div>'; }
    list.forEach((rec)=>{
      const box = document.createElement('div');
      box.style.border='1px solid var(--line)'; box.style.borderRadius='12px'; box.style.padding='10px';
      box.innerHTML = `
        <div class="row">
          <div>
            <div style=\"font-weight:700\">${rec.nome}</div>
            <div class=\"muted\">Criado em: ${new Date(rec.createdAt).toLocaleString('pt-BR')}</div>
          </div>
          <div class=\"right\"></div>
          <button class=\"btn\" data-act=\"abrir\" data-id=\"${rec.id}\">Abrir<\/button>
          <button class=\"btn ghost\" data-act=\"dup\" data-id=\"${rec.id}\">Duplicar<\/button>
          <button class=\"btn danger\" data-act=\"del\" data-id=\"${rec.id}\">Excluir<\/button>
        </div>`;
      box.addEventListener('click', (e)=>{
        const act = e.target?.dataset?.act; const id = e.target?.dataset?.id; if(!act||!id) return;
        const list = loadAll();
        const i = list.findIndex(r=>r.id===id);
        if(i<0) return;
        if(act==='abrir'){ applyRecord(list[i]); modal.style.display='none'; }
        if(act==='dup'){ const copy = JSON.parse(JSON.stringify(list[i])); copy.id = Date.now().toString(36); copy.createdAt=new Date().toISOString(); list.unshift(copy); saveAll(list); openModal(); }
        if(act==='del'){ if(confirm('Excluir esta proposta definitivamente?')){ list.splice(i,1); saveAll(list); openModal(); } }
      });
      listaSalvos.appendChild(box);
    });
    modal.style.display='flex';
  }
  document.getElementById('btnAbrirSalvos').addEventListener('click', openModal);
  document.getElementById('btnFecharModal').addEventListener('click', ()=> modal.style.display='none');

  async function gerarPDF(){
    const res = await (async()=>{ montarPDFView(); const area=document.getElementById('pdf-area'); area.style.display=''; const canvas=await html2canvas(area,{scale:2, background:'#ffffff'}); const img=canvas.toDataURL('image/png'); const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4',compress:true}); const pageWidth=pdf.internal.pageSize.getWidth(); const margin=24; const imgWidth=pageWidth-margin*2; const imgHeight=canvas.height*(imgWidth/canvas.width); pdf.addImage(img,'PNG',margin,margin,imgWidth,imgHeight,'','FAST'); const nome=`Proposta_Mercatto_${($('#evento').value||'Evento')}_${new Date().toISOString().slice(0,10)}.pdf`; lastPdfBlob=pdf.output('blob'); lastPdfName=nome; document.getElementById('btnBaixar').disabled=false; document.getElementById('btnWhats').disabled=false; area.style.display='none'; return {pdf,nome}; })(); return res; }

  document.getElementById('btnGerar').addEventListener('click', async()=>{
    const btn=document.getElementById('btnGerar');
    btn.disabled=true;
    try{
      await gerarPDF();
      salvar();
      clearForm();
    } finally { btn.disabled=false; }
  });
  document.getElementById('btnBaixar').addEventListener('click', async()=>{ if(!lastPdfBlob){ await gerarPDF(); } const a=document.createElement('a'); const url=URL.createObjectURL(lastPdfBlob); a.href=url; a.download=lastPdfName||'Proposta_Mercatto.pdf'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),3000); });
  document.getElementById('btnWhats').addEventListener('click', async()=>{ if(!lastPdfBlob){ await gerarPDF(); } const file=new File([lastPdfBlob], lastPdfName||'Proposta_Mercatto.pdf', {type:'application/pdf'}); if(navigator.canShare && navigator.canShare({files:[file]})){ try{ await navigator.share({files:[file], title:'Proposta Mercatto Del√≠cia', text:'Segue proposta em PDF.'}); return; }catch(err){} } const msg=encodeURIComponent(`Ol√°! Segue a proposta do evento "${$('#evento').value||''}". Baixe o PDF e anexe na conversa.`); const link=`https://wa.me/?text=${msg}`; window.open(link,'_blank'); alert('N√£o foi poss√≠vel anexar o PDF automaticamente neste dispositivo. Baixe o arquivo e anexe manualmente no WhatsApp.'); });
})();
</script>
</body>
</html>
